@model string
@{
    ViewData["Title"] = "Calculate Map PP";
}
<nav class="navbar navbar-expand-sm navbar-light bg-light mb-2">
    <a class="navbar-brand" href="/">delta_t Rebalance Calculator</a>
    <button class="navbar-toggler" type="button" data-toggle="collapse" data-target="#navbarSupportedContent" aria-controls="navbarSupportedContent" aria-expanded="false" aria-label="Toggle navigation">
        <span class="navbar-toggler-icon"></span>
    </button>

    <div class="collapse navbar-collapse" id="navbarSupportedContent">
        <ul class="navbar-nav mr-auto">
            <li class="nav-item">
                <a class="nav-link" href="/Top">Leaderboard</a>
            </li>
            <li class="nav-item">
                <a class="nav-link" href="/Highscores">Highscores</a>
            </li>
            <li class="nav-item active">
                <a class="nav-link" href="#">Calculate map PP <span class="sr-only">(current)</span></a>
            </li>
        </ul>
    </div>
</nav>
<div class="card">
    <form class="card-body">
        <div class="form-group">
            <input type="text" id="id" name="id" class="form-control" placeholder="Map link or ID" />
        </div>
        <div class="form-check form-row">
            <input type="checkbox" id="mod" value="EZ" />
            <label class="form-check-label"><span class="badge badge-success" style="width: 28px">EZ</span></label>
            <input type="checkbox" id="mod" value="NF" />
            <label class="form-check-label"><span class="badge badge-success" style="width: 28px">NF</span></label>
            <input type="checkbox" id="mod" value="HT" />
            <label class="form-check-label"><span class="badge badge-success" style="width: 28px">HT</span></label>
        </div>
        <div class="form-check form-row">
            <input type="checkbox" id="mod" value="HR" />
            <label class="form-check-label"><span class="badge badge-danger" style="width: 28px">HR</span></label>
            <input type="checkbox" id="mod" value="DT" />
            <label class="form-check-label"><span class="badge badge-danger" style="width: 28px">DT</span></label>
            <input type="checkbox" id="mod" value="HD" />
            <label class="form-check-label"><span class="badge badge-danger" style="width: 28px">HD</span></label>
            <input type="checkbox" id="mod" value="FL" />
            <label class="form-check-label"><span class="badge badge-danger" style="width: 28px">FL</span></label>
        </div>
        <div class="form-check form-row">
            <input type="checkbox" id="mod" value="SO" />
            <label class="form-check-label"><span class="badge badge-info" style="width: 28px">SO</span></label>
            <input type="checkbox" id="mod" value="TD" />
            <label class="form-check-label"><span class="badge badge-info" style="width: 28px">TD</span></label>
        </div>
        <div>
            <p id="error" class="text-danger"></p>
            <input type="submit" class="btn btn-secondary" value="Calculate" id="submit" />
        </div>
    </form>
</div>
<hr id="hr" style="display: none"/>
<div class="card" id="map" style="display: none">
    <img id="bg" class="card-img-top" style="max-height: 200px; object-fit: cover;" />
    <div class="card-body">
        <div class="card-img-overlay" style="max-height: 200px;">
            <h4 class="card-title alert alert-light" id="mapname"></h4>
            <p id="sr" class="badge badge-primary"></p>
            <p id="ppwarning" class="text-danger"></p>
        </div>
        <div class="table-responsive">
            <table class="table table-bordered">
                <thead>
                    <th>90%</th>
                    <th>95%</th>
                    <th>98%</th>
                    <th>99%</th>
                    <th>100%</th>
                </thead>
                <tbody>
                    <tr>
                        <td id="pp90"></td>
                        <td id="pp95"></td>
                        <td id="pp98"></td>
                        <td id="pp99"></td>
                        <td id="pp100"></td>
                    </tr>
                </tbody>
            </table>
        </div>
        <canvas id="ppChart"></canvas>
        <hr/>
        <canvas id="probChart"></canvas>
    </div>
</div>

@section Scripts
{
    <script src="https://cdn.jsdelivr.net/npm/chart.js@2.9.2/dist/Chart.min.js"></script>
    <script>
        var ppChart;
        var probChart;
        $(function() {
            var ppctx = document.getElementById('ppChart').getContext('2d');
            ppChart = new Chart(ppctx,
                {
                    aspectRatio: 3,
                    type: 'line',
                    data: {
                        labels: ['90%', '91%', '92%', '93%', '94%', '95%', '96%', '97%', '98%', '99%', '100%']
                    },
                    options: { aspectRatio: 4 }
                });

            var probctx = document.getElementById('probChart').getContext('2d');
            probChart = new Chart(probctx,
                {
                    type: 'scatter',
                    options: {
                        aspectRatio: 3,
                        scales: {
                            xAxes: [
                                {
                                    type: 'linear',
                                    position: 'bottom'
                                }
                            ]
                        }
                    }
                });

            if ('@Model' !== '') {
                $('#id').val('@Model');
                getMap(@Model);
            }
        });

        $("form").on('submit',
            function(e) {
                getMap($('#id').val());

                //stop form submission
                e.preventDefault();
            });

        function getMap(id) {
            $.ajax({
                type: 'GET',
                url: "/CalculateMap",
                traditional: true,
                data: {
                    map: id,
                    mods: $("input:checkbox[id=mod]:checked").map(function() { return $(this).val() }).get()
                },
                error: function(d) {
                    $('#error').html(d.responseJSON.err);
                },
                success: function(d) {
                    var json = JSON.parse(d);

                    if (json.BeatmapSetId != null && json.BeatmapSetId != 0)
                        $('#bg').attr("src",
                            'https://assets.ppy.sh/beatmaps/' + json.BeatmapSetId + '/covers/cover.jpg');
                    else
                        $('#bg').attr("src", null);

                    var mods = json.Mods.map(function(item) {
                        return '<span class="badge badge-secondary">' + item.acronym + '</span>'
                    }).join(" ");
                    $('#mapname').html('<a href=\"https://osu.ppy.sh/beatmaps/' +
                        json.Id +
                        '\">' +
                        json.Title +
                        '</a> ' +
                        mods);

                    $('#sr').html(json.Stars.toFixed(2) + '*');

                    $('#pp100').html(json.PP[10].toFixed(2));
                    $('#pp99').html(json.PP[9].toFixed(2));
                    $('#pp98').html(json.PP[8].toFixed(2));
                    $('#pp95').html(json.PP[5].toFixed(2));
                    $('#pp90').html(json.PP[0].toFixed(2));

                    var incorrectValues = 0;
                    for (var i = 1; i < json.PP.length; i++) {
                        if (json.PP[i] < json.PP[i - 1])
                            incorrectValues++;
                    }

                    if (incorrectValues > 0)
                        $('#ppwarning').html('At least ' +
                            incorrectValues +
                            ' PP values for this map aren\'t entirely correct because of how accuracy is being approximated!');
                    else
                        $('#ppwarning').html('');

                    ppChart.data.datasets = [
                        {
                            backgroundColor: "rgba(0,123,255,0.3)",
                            label: 'pp',
                            cubicInterpolationMode: 'monotone',
                            data: json.PP
                        }];
                    ppChart.update();

                    $.ajax({
                        type: 'GET',
                        url: "/GetProbabilityChart",
                        data: { mapId: json.Id },
                        success: function(d) {
                            var json = JSON.parse(d);

                            probChart.data.datasets = [
                                {
                                    backgroundColor: "rgba(0,123,255,0.3)",
                                    label: '(aim) miss probability',
                                    data: json
                                }];
                            probChart.update();
                            $('#probChart').show();
                        },
                        error: function(d) {
                            $('#probChart').hide();
                        },
                    });

                    $('#hr').show();
                    $('#map').show();
                },
                complete: function() {
                    $('#submit').show();
                },
                beforeSend: function() {
                    $('#error').html('');
                    $('#username').val('');
                    $('#submit').hide();
                }
            });
        }
    </script>
}
